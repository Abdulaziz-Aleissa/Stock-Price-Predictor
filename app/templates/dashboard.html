<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Dashboard - Stock Analytics Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <meta name="description" content="Professional stock analytics dashboard with portfolio tracking, advanced analytics, and real-time market insights.">
    
    <style>
        /* Paper Trading Enhanced Styles */
        .paper-trading-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .paper-trading-header {
            position: relative;
            z-index: 2;
        }

        .paper-trading-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 700;
        }

        .trading-icon {
            font-size: 32px;
        }

        .gradient-text {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 600;
        }

        .practice-badge {
            background: var(--success-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .paper-trading-subtitle {
            color: var(--text-secondary);
            margin: 0;
            font-size: 16px;
        }

        .paper-trading-controls .btn {
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-glass {
            background: rgba(var(--accent-rgb), 0.1);
            border: 1px solid rgba(var(--accent-rgb), 0.3);
            color: var(--accent-color);
            backdrop-filter: blur(10px);
        }

        .btn-glass:hover {
            background: rgba(var(--accent-rgb), 0.2);
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(var(--accent-rgb), 0.3);
        }

        .btn-warning-glass {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
            backdrop-filter: blur(10px);
        }

        .btn-warning-glass:hover {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
            color: #ffc107;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }

        .btn-success-glass {
            background: rgba(var(--success-rgb), 0.1);
            border: 1px solid rgba(var(--success-rgb), 0.3);
            color: var(--success-color);
            backdrop-filter: blur(10px);
        }

        .btn-success-glass:hover {
            background: rgba(var(--success-rgb), 0.2);
            border-color: var(--success-color);
            color: var(--success-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(var(--success-rgb), 0.3);
        }

        .btn-danger-glass {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #dc3545;
            backdrop-filter: blur(10px);
        }

        .btn-danger-glass:hover {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            color: #dc3545;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }

        .btn-outline-glass {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            backdrop-filter: blur(10px);
        }

        .btn-outline-glass:hover {
            background: rgba(var(--accent-rgb), 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: translateY(-2px);
        }

        /* Trading Stats Grid */
        .trading-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card-modern {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card-modern:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            border-color: var(--accent-color);
        }

        .stat-card-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card-modern:hover::before {
            opacity: 1;
        }

        .stat-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .cash-card .stat-icon { background: rgba(var(--success-rgb), 0.1); }
        .portfolio-card .stat-icon { background: rgba(var(--accent-rgb), 0.1); }
        .total-card .stat-icon { background: rgba(59, 130, 246, 0.1); }
        .profit-card .stat-icon { background: rgba(var(--success-rgb), 0.1); }
        .loss-card .stat-icon { background: rgba(220, 53, 69, 0.1); }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .stat-trend {
            color: var(--text-muted);
            font-size: 12px;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
        }

        .profit-text { color: var(--success-color); }
        .loss-text { color: #dc3545; }

        /* Holdings Section */
        .holdings-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
        }

        .holdings-title {
            color: var(--text-primary);
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .holdings-count {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
        }

        .trading-buttons {
            display: flex;
            gap: 8px;
        }

        .holdings-table-container {
            margin-top: 16px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .holdings-table {
            width: 100%;
            margin: 0;
            background: var(--card-bg);
        }

        .holdings-table thead {
            background: var(--bg-tertiary);
        }

        .holdings-table th {
            padding: 16px 12px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
            border-bottom: 1px solid var(--border-color);
        }

        .holdings-table td {
            padding: 16px 12px;
            border: none;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 500;
        }

        .holding-row:hover {
            background: var(--bg-secondary);
        }

        .symbol-badge {
            background: var(--accent-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }
        
        /* Ensure symbol badges work well in both themes */
        [data-theme="dark"] .symbol-badge {
            color: white;
        }
        
        [data-theme="light"] .symbol-badge {
            color: white;
        }

        .purchase-price-cell {
            color: var(--accent-color);
            font-weight: 600;
        }

        .pl-value {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .profit-cell { color: var(--success-color); }
        .loss-cell { color: #dc3545; }

        .return-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .profit-badge {
            background: rgba(var(--success-rgb), 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .loss-badge {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid #dc3545;
            color: #dc3545;
        }

        /* Empty State */
        .empty-portfolio-cell {
            padding: 60px 20px !important;
            text-align: center;
        }

        .empty-state {
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-subtitle {
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* Transaction History */
        .transactions-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            height: fit-content;
        }

        .transactions-title {
            color: var(--text-primary);
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transaction-history-container {
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
        }

        .loading-state, .no-transactions-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-muted);
        }

        .no-transactions-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .no-transactions-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .no-transactions-subtitle {
            font-size: 14px;
            color: white;
        }

        .transaction-list {
            padding: 12px;
        }

        .transaction-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
        }

        .transaction-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .transaction-symbol {
            font-weight: 600;
            color: var(--text-primary);
        }

        .transaction-amount {
            font-weight: 600;
            font-size: 16px;
        }

        .transaction-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
        }

        .buy-transaction {
            border-left: 4px solid var(--success-color);
        }

        .sell-transaction {
            border-left: 4px solid #dc3545;
        }

        /* Flash Messages */
        .flash-messages-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
            max-width: 400px;
        }

        .flash-message {
            margin-bottom: 10px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Auto-hide flash messages after 5 seconds */
        .flash-message {
            animation: slideInRight 0.3s ease-out, fadeOut 0.5s ease-out 4.5s forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .trading-stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .stat-card-modern {
                padding: 20px;
            }

            .paper-trading-container {
                padding: 24px;
            }

            .holdings-table {
                font-size: 14px;
            }

            .holdings-table th,
            .holdings-table td {
                padding: 12px 8px;
            }

            .flash-messages-container {
                position: fixed;
                top: 70px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Professional Theme Switch -->
        <div class="theme-switch">
            <div class="switch-track">
                <div class="switch-icons">
                    <div class="sun">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                    </div>
                    <div class="moon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </div>
                </div>
                <div class="switch-circle"></div>
            </div>
        </div>

        <!-- Professional Navigation Header -->
        <div class="nav-header">
            <div class="nav-container">
                <a href="{{ url_for('index') }}" class="logo">Stock Analytics Pro</a>
                <div class="nav-links">
                    <span class="user-welcome">👤 {{ current_user.username }}</span>
                    <a href="{{ url_for('financial_literacy') }}" class="btn-secondary btn-sm">📚 Education</a>
                    <a href="{{ url_for('index') }}" class="btn-secondary btn-sm">🔍 New Analysis</a>
                    <button class="btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#stockScoringModal">
                        📊 Scoring
                    </button>
                    <a href="{{ url_for('logout') }}" class="btn-outline btn-sm">🚪 Logout</a>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages-container animate-fade-in">
            {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'warning' }} alert-dismissible flash-message" role="alert">
                {% if category == 'success' %}
                <strong>✅ Success:</strong> {{ message }}
                {% else %}
                <strong>⚠️ Notice:</strong> {{ message }}
                {% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Notifications -->
        {% if notifications %}
        <div class="notifications-container animate-fade-in">
            {% for notification in notifications %}
            <div class="alert alert-info notification-item">
                {{ notification.message }}
                <a href="{{ url_for('mark_notification_read', notification_id=notification.id) }}" 
                   class="btn-close notification-close"></a>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Main Dashboard Content -->
        <div class="content-wrapper">
            <div class="content-box dashboard animate-fade-in">
                
                <!-- Dashboard Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="mb-2">Professional Dashboard</h1>
                        <p class="text-muted mb-0 dashboard-welcome-text">Welcome back, {{ current_user.username }}! Your comprehensive analytics platform.</p>
                    </div>
                </div>
                <!-- Portfolio Summary Stats -->
                <div class="stats-grid mb-4">
                    <div class="stat-card animate-slide-in">
                        <div class="stat-value">${{ "%.2f"|format(summary.total_value) }}</div>
                        <div class="stat-label">Total Portfolio Value</div>
                    </div>
                    <div class="stat-card animate-slide-in" style="animation-delay: 0.1s;">
                        <div class="stat-value">${{ "%.2f"|format(summary.total_cost) }}</div>
                        <div class="stat-label">Total Investment</div>
                    </div>
                    <div class="stat-card animate-slide-in" style="animation-delay: 0.2s;">
                        <div class="stat-value {{ 'positive' if summary.total_profit_loss > 0 else 'negative' }}">${{ "%.2f"|format(summary.total_profit_loss) }}</div>
                        <div class="stat-label">Profit/Loss</div>
                        <div class="stat-change {{ 'positive' if summary.total_return_percent > 0 else 'negative' }}">
                            {{ "%.2f"|format(summary.total_return_percent) }}%
                        </div>
                    </div>
                    <div class="stat-card animate-slide-in" style="animation-delay: 0.3s;">
                        <div class="stat-value">{{ portfolio|length }}</div>
                        <div class="stat-label">Active Positions</div>
                    </div>
                </div>

                <div class="row">
                    <!-- Portfolio Section -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h3 class="card-title">📊 Portfolio Holdings</h3>
                                    <button class="btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#addPortfolioModal">
                                        + Add Stock
                                    </button>
                                </div>
                            </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                            <thead style="background: var(--bg-tertiary); color: var(--text-primary);">
                                <tr>
                                    <th style="color: var(--text-primary);">Symbol</th>
                                    <th style="color: var(--text-primary);">Shares</th>
                                    <th style="color: var(--text-primary);">Buy Price</th>
                                    <th style="color: var(--text-primary);">Current</th>
                                    <th style="color: var(--text-primary);">Value</th>
                                    <th style="color: var(--text-primary);">P/L</th>
                                    <th style="color: var(--text-primary);">Change</th>
                                    <th style="color: var(--text-primary);"></th>
                                </tr>
                            </thead>
                            <tbody style="color: var(--text-secondary);">
                                {% for item in portfolio %}
                                <tr style="background: var(--card-bg); border-color: var(--border-color);">
                                    <td style="color: var(--text-primary);">{{ item.symbol }}</td>
                                    <td>{{ "%.2f"|format(item.shares) }}</td>
                                    <td>${{ "%.2f"|format(item.purchase_price) }}</td>
                                    <td>${{ "%.2f"|format(item.current_price) }}</td>
                                    <td>${{ "%.2f"|format(item.position_value) }}</td>
                                    <td class="{{ 'positive-change' if item.profit_loss > 0 else 'negative-change' }}">
                                        ${{ "%.2f"|format(item.profit_loss) }}
                                    </td>
                                    <td class="{{ 'positive-change' if item.change_percent > 0 else 'negative-change' }}">
                                        {{ "%.2f"|format(item.change_percent) }}%
                                    </td>
                                    <td>
                                        <a href="{{ url_for('remove_from_portfolio', item_id=item.id) }}" 
                                           class="btn btn-outline-danger btn-sm">Remove</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Watchlist Section -->
            <div class="col-md-6">
                <div class="metrics-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Watchlist</h2>
                        <button class="btn btn-custom btn-sm" data-bs-toggle="modal" data-bs-target="#addWatchlistModal">
                            Add Stock
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                            <thead style="background: var(--bg-tertiary); color: var(--text-primary);">
                                <tr>
                                    <th style="color: var(--text-primary);">Symbol</th>
                                    <th style="color: var(--text-primary);">Target</th>
                                    <th style="color: var(--text-primary);">Current</th>
                                    <th style="color: var(--text-primary);">Distance</th>
                                    <th style="color: var(--text-primary);"></th>
                                </tr>
                            </thead>
                            <tbody style="color: var(--text-secondary);">
                                {% for item in watchlist %}
                                <tr style="background: var(--card-bg); border-color: var(--border-color);">
                                    <td style="color: var(--text-primary);">{{ item.symbol }}</td>
                                    <td>${{ "%.2f"|format(item.target_price) }}</td>
                                    <td>${{ "%.2f"|format(item.current_price) }}</td>
                                    <td class="{{ 'positive-change' if item.current_price >= item.target_price else 'negative-change' }}">
                                        {{ "%.1f"|format(item.percent_to_target) }}%
                                    </td>
                                    <td>
                                        <a href="{{ url_for('remove_from_watchlist', item_id=item.id) }}" 
                                           class="btn btn-outline-danger btn-sm">Remove</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Price Alerts Section -->
            <div class="col-md-12 mt-4">
                <div class="metrics-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Price Alerts</h2>
                        <button class="btn btn-custom btn-sm" data-bs-toggle="modal" data-bs-target="#addAlertModal">
                            Add Alert
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                            <thead style="background: var(--bg-tertiary); color: var(--text-primary);">
                                <tr>
                                    <th style="color: var(--text-primary);">Symbol</th>
                                    <th style="color: var(--text-primary);">Condition</th>
                                    <th style="color: var(--text-primary);">Target Price</th>
                                    <th style="color: var(--text-primary);">Current Price</th>
                                    <th style="color: var(--text-primary);">Status</th>
                                    <th style="color: var(--text-primary);"></th>
                                </tr>
                            </thead>
                            <tbody style="color: var(--text-secondary);">
                                {% for alert in alerts %}
                                <tr style="background: var(--card-bg); border-color: var(--border-color);">
                                    <td style="color: var(--text-primary);">{{ alert.symbol }}</td>
                                    <td>Goes {{ alert.condition }}</td>
                                    <td>${{ "%.2f"|format(alert.target_price) }}</td>
                                    <td>${{ "%.2f"|format(alert.current_price) }}</td>
                                    <td>
                                        {% if alert.is_active %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Triggered</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('remove_alert', alert_id=alert.id) }}" 
                                           class="btn btn-outline-danger btn-sm">Remove</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stock Comparison Section -->
            <div class="col-md-12 mt-4">
                <div class="metrics-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Stock Comparison</h2>
                        <button class="btn btn-custom btn-sm" data-bs-toggle="modal" data-bs-target="#compareStocksModal">
                            Compare Stocks
                        </button>
                    </div>
                    <div id="comparisonChart"></div>
                </div>
            </div>

            <!-- Advanced Analytics Section -->
            <div class="col-md-12 mt-4">
                <div class="metrics-card">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                        <div class="mb-3 mb-md-0">
                            <h2 class="mb-1">🚀 Advanced Analytics</h2>
                            <p class="text-muted dashboard-description mb-0">Professional quantitative analysis tools for informed investment decisions</p>
                        </div>
                        <div class="d-flex flex-wrap gap-3" role="group">
                            <button class="btn btn-custom btn-sm mb-2" data-bs-toggle="modal" data-bs-target="#fundamentalRiskModal">
                                🏛️ Fundamental Risk
                            </button>
                            <button class="btn btn-custom btn-sm mb-2" data-bs-toggle="modal" data-bs-target="#technicalRiskModal">
                                📊 Technical Risk
                            </button>
                            <button class="btn btn-custom btn-sm mb-2" data-bs-toggle="modal" data-bs-target="#varAnalysisModal">
                                ⚠️ Value at Risk
                            </button>
                            <button class="btn btn-custom btn-sm mb-2" data-bs-toggle="modal" data-bs-target="#timeSeriesModal">
                                📈 Time Series
                            </button>
                        </div>
                    </div>
                    <div class="alert alert-info mb-3">
                        <strong>💡 Advanced Risk Analysis Tools:</strong> Comprehensive suite of quantitative analytics for professional-grade investment analysis and risk management.
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="analytics-feature">
                                <h5>🏛️ Fundamental Risk Analysis</h5>
                                <p><strong>Financial Health:</strong> Evaluate bankruptcy risk using Altman Z-Score and assess debt coverage with Interest Coverage Ratio for comprehensive financial stability analysis</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="analytics-feature">
                                <h5>📊 Technical Risk Analysis</h5>
                                <p><strong>Market Volatility:</strong> Analyze downside risk using Average True Range (ATR) and support levels to assess price volatility and potential drawdowns</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="analytics-feature">
                                <h5>⚠️ Value at Risk (VaR)</h5>
                                <p><strong>Risk Assessment:</strong> Quantify potential losses using Historical, Parametric, and Monte Carlo VaR methods with Expected Shortfall analysis</p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="analytics-feature">
                                <h5>📈 Time Series Forecasting</h5>
                                <p><strong>Predictive Analytics:</strong> Advanced ARIMA and GARCH models for price and volatility forecasting with statistical validation</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Paper Trading Section -->
                <div class="mb-5">
                    <div class="paper-trading-container">
                        <div class="paper-trading-header">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h2 class="paper-trading-title">
                                        <span class="trading-icon">💰</span>
                                        <span class="gradient-text">Paper Trading Practice</span>
                                        <span class="practice-badge">Risk Free</span>
                                    </h2>
                                    <p class="paper-trading-subtitle">Practice trading with virtual money - Zero risk, real learning!</p>
                                </div>
                                <div class="paper-trading-controls">
                                    <button class="btn btn-glass btn-sm me-2" data-bs-toggle="modal" data-bs-target="#paperTradingInfoModal">
                                        <i class="fas fa-info-circle"></i> Learn More
                                    </button>
                                    <button class="btn btn-warning-glass btn-sm" onclick="confirmResetPaperPortfolio()">
                                        <i class="fas fa-redo-alt"></i> Reset Portfolio
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Paper Trading Stats -->
                        <div class="trading-stats-grid mb-4">
                            <div class="stat-card-modern cash-card">
                                <div class="stat-icon">💵</div>
                                <div class="stat-content">
                                    <div class="stat-value">${{ "%.2f"|format(paper_summary.cash_balance) }}</div>
                                    <div class="stat-label">Virtual Cash</div>
                                    <div class="stat-trend">Available to invest</div>
                                </div>
                            </div>
                            <div class="stat-card-modern portfolio-card">
                                <div class="stat-icon">📈</div>
                                <div class="stat-content">
                                    <div class="stat-value">${{ "%.2f"|format(paper_summary.total_value) }}</div>
                                    <div class="stat-label">Stock Value</div>
                                    <div class="stat-trend">Current positions</div>
                                </div>
                            </div>
                            <div class="stat-card-modern total-card">
                                <div class="stat-icon">🏦</div>
                                <div class="stat-content">
                                    <div class="stat-value">${{ "%.2f"|format(paper_summary.total_account_value) }}</div>
                                    <div class="stat-label">Total Account</div>
                                    <div class="stat-trend">Portfolio value</div>
                                </div>
                            </div>
                            <div class="stat-card-modern {{ 'profit-card' if paper_summary.total_profit_loss > 0 else 'loss-card' }}">
                                <div class="stat-icon">{{ '🚀' if paper_summary.total_profit_loss > 0 else '📉' }}</div>
                                <div class="stat-content">
                                    <div class="stat-value {{ 'profit-text' if paper_summary.total_profit_loss > 0 else 'loss-text' }}">${{ "%.2f"|format(paper_summary.total_profit_loss) }}</div>
                                    <div class="stat-label">Profit/Loss</div>
                                    <div class="stat-change {{ 'profit-text' if paper_summary.total_return_percent > 0 else 'loss-text' }}">
                                        {{ "%.2f"|format(paper_summary.total_return_percent) }}% return
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Enhanced Portfolio Holdings -->
                            <div class="col-lg-8">
                                <div class="holdings-section">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="holdings-title">
                                            <i class="fas fa-chart-line"></i> Virtual Holdings
                                            <span class="holdings-count">({{ paper_portfolio|length }} positions)</span>
                                        </h4>
                                        <div class="trading-buttons">
                                            <button class="btn btn-success-glass btn-sm me-2" data-bs-toggle="modal" data-bs-target="#paperBuyModal">
                                                <i class="fas fa-plus-circle"></i> Buy Stock
                                            </button>
                                            <button class="btn btn-danger-glass btn-sm" data-bs-toggle="modal" data-bs-target="#paperSellModal">
                                                <i class="fas fa-minus-circle"></i> Sell Stock
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="holdings-table-container">
                                        <table class="holdings-table">
                                            <thead>
                                                <tr>
                                                    <th><i class="fas fa-tag"></i> Symbol</th>
                                                    <th><i class="fas fa-layer-group"></i> Shares</th>
                                                    <th><i class="fas fa-shopping-cart"></i> Purchase Price</th>
                                                    <th><i class="fas fa-dollar-sign"></i> Current Price</th>
                                                    <th><i class="fas fa-receipt"></i> Total Cost</th>
                                                    <th><i class="fas fa-coins"></i> Current Value</th>
                                                    <th><i class="fas fa-chart-area"></i> P/L</th>
                                                    <th><i class="fas fa-percentage"></i> Return %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in paper_portfolio %}
                                                <tr class="holding-row">
                                                    <td class="symbol-cell">
                                                        <div class="symbol-badge">{{ item.symbol }}</div>
                                                    </td>
                                                    <td class="shares-cell">{{ "%.2f"|format(item.shares) }}</td>
                                                    <td class="purchase-price-cell">${{ "%.2f"|format(item.average_price) }}</td>
                                                    <td class="current-price-cell">${{ "%.2f"|format(item.current_price) }}</td>
                                                    <td class="cost-cell">${{ "%.2f"|format(item.shares * item.average_price) }}</td>
                                                    <td class="value-cell">${{ "%.2f"|format(item.position_value) }}</td>
                                                    <td class="pl-cell {{ 'profit-cell' if item.profit_loss > 0 else 'loss-cell' }}">
                                                        <div class="pl-value">
                                                            <i class="fas {{ 'fa-arrow-up' if item.profit_loss > 0 else 'fa-arrow-down' }}"></i>
                                                            ${{ "%.2f"|format(item.profit_loss) }}
                                                        </div>
                                                    </td>
                                                    <td class="return-cell {{ 'profit-cell' if item.change_percent > 0 else 'loss-cell' }}">
                                                        <div class="return-badge {{ 'profit-badge' if item.change_percent > 0 else 'loss-badge' }}">
                                                            {{ "%.2f"|format(item.change_percent) }}%
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                {% if not paper_portfolio %}
                                                <tr class="empty-portfolio-row">
                                                    <td colspan="8" class="empty-portfolio-cell">
                                                        <div class="empty-state">
                                                            <div class="empty-icon">📊</div>
                                                            <div class="empty-title">Ready to Start Trading?</div>
                                                            <div class="empty-subtitle">No positions yet. Click "Buy Stock" to start your investment journey!</div>
                                                            <button class="btn btn-success-glass btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#paperBuyModal">
                                                                <i class="fas fa-rocket"></i> Make Your First Trade
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Enhanced Transaction History -->
                            <div class="col-lg-4">
                                <div class="transactions-section">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="transactions-title">
                                            <i class="fas fa-history"></i> Trading History
                                        </h4>
                                        <button class="btn btn-outline-glass btn-sm" onclick="loadPaperTransactions()">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                    </div>
                                    <div id="paperTransactionHistory" class="transaction-history-container">
                                        <div class="loading-state">
                                            <div class="loading-spinner"></div>
                                            <div class="loading-text">Loading your trading history...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add to Portfolio Modal -->
    <div class="modal fade" id="addPortfolioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add to Portfolio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('add_to_portfolio') }}" method="POST">
                        <div class="mb-3">
                            <input type="text" class="form-control" name="symbol" placeholder="Stock Symbol" required>
                        </div>
                        <div class="mb-3">
                            <input type="number" class="form-control" name="shares" placeholder="Number of Shares" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <input type="number" class="form-control" name="purchase_price" placeholder="Purchase Price" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">Add to Portfolio</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add to Watchlist Modal -->
    <div class="modal fade" id="addWatchlistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add to Watchlist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('add_to_watchlist') }}" method="POST">
                        <div class="mb-3">
                            <input type="text" class="form-control" name="symbol" placeholder="Stock Symbol" required>
                        </div>
                        <div class="mb-3">
                            <input type="number" class="form-control" name="target_price" placeholder="Target Price" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">Add to Watchlist</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Alert Modal -->
    <div class="modal fade" id="addAlertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Price Alert</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('add_alert') }}" method="POST">
                        <div class="mb-3">
                            <input type="text" class="form-control" name="symbol" placeholder="Stock Symbol" required>
                        </div>
                        <div class="mb-3">
                            <select class="form-control" name="condition" required>
                                <option value="above">Price Goes Above</option>
                                <option value="below">Price Goes Below</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <input type="number" class="form-control" name="target_price" placeholder="Target Price" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">Set Alert</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Stocks Modal -->
    <div class="modal fade" id="compareStocksModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Compare Stocks</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="compareStocksForm">
                        <div class="mb-3">
                            <input type="text" class="form-control" name="symbol1" placeholder="First Stock Symbol" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" name="symbol2" placeholder="Second Stock Symbol" required>
                        </div>
                        <div class="mb-3">
                            <select class="form-control" name="timeframe">
                                <option value="1mo">1 Month</option>
                                <option value="3mo">3 Months</option>
                                <option value="6mo">6 Months</option>
                                <option value="1y">1 Year</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">Compare</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Scoring Modal -->
    <div class="modal fade" id="stockScoringModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stock Scoring & Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="stockScoringForm">
                        <div class="mb-3">
                            <label class="form-label">Stock Symbols (comma-separated for multiple)</label>
                            <input type="text" class="form-control" name="symbols" placeholder="e.g., AAPL, MSFT, GOOGL" required>
                            <div class="form-text">Enter one or more stock symbols separated by commas</div>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">
                            <span class="spinner-border spinner-border-sm d-none" id="scoringSpinner"></span>
                            Analyze Stocks
                        </button>
                    </form>
                    
                    <div id="scoringResults" class="mt-4" style="display: none;">
                        <hr>
                        <h6>Analysis Results</h6>
                        <div class="table-responsive">
                            <table class="table table-hover" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                                <thead style="background: var(--bg-tertiary); color: var(--text-primary);">
                                    <tr>
                                        <th style="color: var(--text-primary);">Symbol</th>
                                        <th style="color: var(--text-primary);">P/E</th>
                                        <th style="color: var(--text-primary);">P/B</th>
                                        <th style="color: var(--text-primary);">ROE</th>
                                        <th style="color: var(--text-primary);">EV/EBITDA</th>
                                        <th style="color: var(--text-primary);">RSI</th>
                                        <th style="color: var(--text-primary);">Volatility</th>
                                        <th style="color: var(--text-primary);">Total Score</th>
                                        <th style="color: var(--text-primary);">Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody id="scoringTableBody" style="color: var(--text-secondary);">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="scoringError" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fundamental Risk Analysis Modal -->
    <div class="modal fade" id="fundamentalRiskModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">🏛️ Fundamental Risk Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="fundamentalRiskForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Stock Symbol</label>
                                    <input type="text" class="form-control" name="symbol" placeholder="e.g., AAPL" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Working Capital (millions $)</label>
                                    <input type="number" class="form-control" name="working_capital" placeholder="e.g., 2500" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Retained Earnings (millions $)</label>
                                    <input type="number" class="form-control" name="retained_earnings" placeholder="e.g., 15000" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">EBIT (millions $)</label>
                                    <input type="number" class="form-control" name="ebit" placeholder="e.g., 8500" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Market Cap (millions $)</label>
                                    <input type="number" class="form-control" name="market_cap" placeholder="e.g., 180000" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Total Assets (millions $)</label>
                                    <input type="number" class="form-control" name="total_assets" placeholder="e.g., 35000" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Total Liabilities (millions $)</label>
                                    <input type="number" class="form-control" name="total_liabilities" placeholder="e.g., 20000" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Sales/Revenue (millions $)</label>
                                    <input type="number" class="form-control" name="sales" placeholder="e.g., 25000" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Interest Expense (millions $)</label>
                                    <input type="number" class="form-control" name="interest_expense" placeholder="e.g., 150" required>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">
                            <span class="spinner-border spinner-border-sm d-none" id="fundamentalRiskSpinner"></span>
                            Run Fundamental Risk Analysis
                        </button>
                    </form>
                    
                    <div id="fundamentalRiskResults" class="mt-4" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Altman Z-Score Analysis</h6>
                                <div id="altmanZScore"></div>
                            </div>
                            <div class="col-md-6">
                                <h6>Interest Coverage Ratio</h6>
                                <div id="interestCoverage"></div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Risk Assessment</h6>
                            <div id="fundamentalRiskAssessment"></div>
                        </div>
                    </div>
                    
                    <div id="fundamentalRiskError" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technical Risk Analysis Modal -->
    <div class="modal fade" id="technicalRiskModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">📊 Technical Risk Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="technicalRiskForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Stock Symbol</label>
                                    <input type="text" class="form-control" name="symbol" placeholder="e.g., AAPL" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Support Level ($) - Optional</label>
                                    <input type="number" class="form-control" name="support_level" step="0.01" placeholder="e.g., 150.00 (Leave blank to use 6-month low)">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">
                            <span class="spinner-border spinner-border-sm d-none" id="technicalRiskSpinner"></span>
                            Run Technical Risk Analysis
                        </button>
                    </form>
                    
                    <div id="technicalRiskResults" class="mt-4" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>ATR Analysis</h6>
                                <div id="atrAnalysis"></div>
                            </div>
                            <div class="col-md-6">
                                <h6>Support Zone Analysis</h6>
                                <div id="supportZoneAnalysis"></div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Risk Assessment</h6>
                            <div id="technicalRiskAssessment"></div>
                        </div>
                    </div>
                    
                    <div id="technicalRiskError" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Value at Risk Analysis Modal -->
    <div class="modal fade" id="varAnalysisModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">⚠️ Value at Risk (VaR) Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="varAnalysisForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stock Symbol</label>
                                    <input type="text" class="form-control" name="symbol" placeholder="e.g., AAPL" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Portfolio Value ($)</label>
                                    <input type="number" class="form-control" name="portfolio_value" value="10000" min="1000" max="10000000" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Holding Period (Days)</label>
                                    <select class="form-control" name="holding_period">
                                        <option value="1" selected>1 Day</option>
                                        <option value="5">5 Days (1 Week)</option>
                                        <option value="10">10 Days</option>
                                        <option value="21">21 Days (1 Month)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Confidence Levels</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="confidence_95" value="0.95" checked>
                                        <label class="form-check-label">95% Confidence</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="confidence_99" value="0.99" checked>
                                        <label class="form-check-label">99% Confidence</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Analysis Type</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="include_historical" checked>
                                        <label class="form-check-label">Historical VaR</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="include_parametric" checked>
                                        <label class="form-check-label">Parametric VaR</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">
                            <span class="spinner-border spinner-border-sm d-none" id="varAnalysisSpinner"></span>
                            Run VaR Analysis
                        </button>
                    </form>
                    
                    <div id="varAnalysisResults" class="mt-4" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Risk Metrics Overview</h6>
                                <div id="varRiskMetrics"></div>
                            </div>
                            <div class="col-md-6">
                                <h6>VaR Comparison</h6>
                                <div id="varComparison"></div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Expected Shortfall (CVaR)</h6>
                                <div id="expectedShortfall"></div>
                            </div>
                            <div class="col-md-6">
                                <h6>Risk Assessment</h6>
                                <div id="varRiskAssessment"></div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Risk Distribution Visualization</h6>
                            <div id="varChart"></div>
                        </div>
                        <div class="mt-3">
                            <h6>Risk Management Recommendations</h6>
                            <div id="varRecommendations"></div>
                        </div>
                    </div>
                    
                    <div id="varAnalysisError" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Series Forecasting Modal -->
    <div class="modal fade" id="timeSeriesModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">📈 Time Series Forecasting (ARIMA/GARCH)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="timeSeriesForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stock Symbol</label>
                                    <input type="text" class="form-control" name="symbol" placeholder="e.g., AAPL" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Forecast Horizon (Days)</label>
                                    <select class="form-control" name="forecast_days">
                                        <option value="7">7 Days</option>
                                        <option value="14">14 Days</option>
                                        <option value="30" selected>30 Days</option>
                                        <option value="60">60 Days</option>
                                        <option value="90">90 Days</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Analysis Type</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="include_price_forecast" checked>
                                        <label class="form-check-label">Price Forecasting (ARIMA)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="include_volatility_forecast" checked>
                                        <label class="form-check-label">Volatility Forecasting (GARCH)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>🔬 Advanced Models:</strong> ARIMA models capture price trends and patterns, while GARCH models forecast volatility clustering and market risk dynamics.
                        </div>
                        <button type="submit" class="btn btn-custom w-100">
                            <span class="spinner-border spinner-border-sm d-none" id="timeSeriesSpinner"></span>
                            Generate Forecasts
                        </button>
                    </form>
                    
                    <div id="timeSeriesResults" class="mt-4" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Forecast Summary</h6>
                                <div id="forecastSummary"></div>
                            </div>
                            <div class="col-md-6">
                                <h6>Model Performance</h6>
                                <div id="modelPerformance"></div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Price Forecast Visualization</h6>
                            <div id="priceForecastChart"></div>
                        </div>
                        <div class="mt-3">
                            <h6>Volatility Forecast Visualization</h6>
                            <div id="volatilityForecastChart"></div>
                        </div>
                        <div class="mt-3">
                            <h6>Investment Insights & Recommendations</h6>
                            <div id="forecastInsights"></div>
                        </div>
                    </div>
                    
                    <div id="timeSeriesError" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script>
    document.getElementById('compareStocksForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/compare_stocks', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            compareStocks(data);
            const modal = bootstrap.Modal.getInstance(document.getElementById('compareStocksModal'));
            modal.hide();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    // Stock Scoring Form Handler
    document.getElementById('stockScoringForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const spinner = document.getElementById('scoringSpinner');
        const resultsDiv = document.getElementById('scoringResults');
        const errorDiv = document.getElementById('scoringError');
        const tableBody = document.getElementById('scoringTableBody');
        
        // Show loading state
        spinner.classList.remove('d-none');
        resultsDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        fetch('/stock_scoring', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            spinner.classList.add('d-none');
            
            if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
                return;
            }
            
            // Clear previous results
            tableBody.innerHTML = '';
            
            // Populate results table
            data.results.forEach(stock => {
                const row = tableBody.insertRow();
                
                // Recommendation badge class
                let badgeClass = 'bg-secondary';
                if (stock.recommendation === 'BUY') badgeClass = 'bg-success';
                else if (stock.recommendation === 'SELL') badgeClass = 'bg-danger';
                else if (stock.recommendation === 'HOLD') badgeClass = 'bg-warning';
                
                row.innerHTML = `
                    <td><strong>${stock.symbol}</strong></td>
                    <td>${stock.metrics.pe_ratio !== null ? stock.metrics.pe_ratio.toFixed(2) : 'N/A'}</td>
                    <td>${stock.metrics.pb_ratio !== null ? stock.metrics.pb_ratio.toFixed(2) : 'N/A'}</td>
                    <td>${stock.metrics.roe !== null ? stock.metrics.roe.toFixed(2) + '%' : 'N/A'}</td>
                    <td>${stock.metrics.ev_ebitda !== null ? stock.metrics.ev_ebitda.toFixed(2) : 'N/A'}</td>
                    <td>${stock.metrics.rsi !== null ? stock.metrics.rsi.toFixed(2) : 'N/A'}</td>
                    <td>${stock.metrics.volatility !== null ? (stock.metrics.volatility * 100).toFixed(2) + '%' : 'N/A'}</td>
                    <td><strong>${stock.total_score}</strong></td>
                    <td>
                        <span class="badge ${badgeClass}" data-bs-toggle="tooltip" title="${stock.reasoning}">
                            ${stock.recommendation}
                        </span>
                    </td>
                `;
            });
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            resultsDiv.style.display = 'block';
        })
        .catch(error => {
            spinner.classList.add('d-none');
            errorDiv.textContent = 'An error occurred while analyzing stocks. Please try again.';
            errorDiv.style.display = 'block';
            console.error('Error:', error);
        });
    });

    function compareStocks(data) {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        
        const trace1 = {
            x: data.symbol1.dates,
            y: data.symbol1.prices,
            name: data.symbol1.symbol,
            type: 'scatter',
            line: { width: 2 }
        };
        
        const trace2 = {
            x: data.symbol2.dates,
            y: data.symbol2.prices,
            name: data.symbol2.symbol,
            type: 'scatter',
            line: { width: 2 }
        };
        
        const layout = {
            title: 'Stock Price Comparison',
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { 
                color: isDark ? '#e0e0e0' : '#1a202c',
            },
            xaxis: {
                title: 'Date',
                gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            },
            yaxis: {
                title: 'Price ($)',
                gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            },
            showlegend: true,
            legend: {
                x: 0,
                y: 1,
                bgcolor: isDark ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.5)'
            }
        };
        
        Plotly.newPlot('comparisonChart', [trace1, trace2], layout);
    }

    // Update comparison chart when theme changes
    document.querySelector('.theme-switch').addEventListener('click', () => {
        const chartDiv = document.getElementById('comparisonChart');
        if (chartDiv.data) {
            compareStocks({
                symbol1: {
                    symbol: chartDiv.data[0].name,
                    dates: chartDiv.data[0].x,
                    prices: chartDiv.data[0].y
                },
                symbol2: {
                    symbol: chartDiv.data[1].name,
                    dates: chartDiv.data[1].x,
                    prices: chartDiv.data[1].y
                }
            });
        }
    });

    // Fundamental Risk Analysis Form Handler
    document.getElementById('fundamentalRiskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const spinner = document.getElementById('fundamentalRiskSpinner');
        const resultsDiv = document.getElementById('fundamentalRiskResults');
        const errorDiv = document.getElementById('fundamentalRiskError');
        
        // Show loading state
        spinner.classList.remove('d-none');
        resultsDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        fetch('/fundamental_risk_analysis', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            spinner.classList.add('d-none');
            
            if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
                return;
            }
            
            displayFundamentalRiskResults(data.results);
            resultsDiv.style.display = 'block';
        })
        .catch(error => {
            spinner.classList.add('d-none');
            errorDiv.textContent = 'An error occurred during fundamental risk analysis. Please try again.';
            errorDiv.style.display = 'block';
            console.error('Error:', error);
        });
    });

    // Technical Risk Analysis Form Handler
    document.getElementById('technicalRiskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const spinner = document.getElementById('technicalRiskSpinner');
        const resultsDiv = document.getElementById('technicalRiskResults');
        const errorDiv = document.getElementById('technicalRiskError');
        
        // Show loading state
        spinner.classList.remove('d-none');
        resultsDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        fetch('/technical_risk_analysis', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            spinner.classList.add('d-none');
            
            if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
                return;
            }
            
            displayTechnicalRiskResults(data.results);
            resultsDiv.style.display = 'block';
        })
        .catch(error => {
            spinner.classList.add('d-none');
            errorDiv.textContent = 'An error occurred during technical risk analysis. Please try again.';
            errorDiv.style.display = 'block';
            console.error('Error:', error);
        });
    });

    // VaR Analysis Form Handler
    document.getElementById('varAnalysisForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const spinner = document.getElementById('varAnalysisSpinner');
        const resultsDiv = document.getElementById('varAnalysisResults');
        const errorDiv = document.getElementById('varAnalysisError');
        
        // Show loading state
        spinner.classList.remove('d-none');
        resultsDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        fetch('/value_at_risk', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            spinner.classList.add('d-none');
            
            if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
                return;
            }
            
            displayVarAnalysisResults(data.results);
            resultsDiv.style.display = 'block';
        })
        .catch(error => {
            spinner.classList.add('d-none');
            errorDiv.textContent = 'An error occurred during VaR analysis. Please try again.';
            errorDiv.style.display = 'block';
            console.error('Error:', error);
        });
    });

    // Time Series Forecasting Form Handler
    document.getElementById('timeSeriesForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const spinner = document.getElementById('timeSeriesSpinner');
        const resultsDiv = document.getElementById('timeSeriesResults');
        const errorDiv = document.getElementById('timeSeriesError');
        
        // Show loading state
        spinner.classList.remove('d-none');
        resultsDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        fetch('/time_series_forecasting', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            spinner.classList.add('d-none');
            
            if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
                return;
            }
            
            displayTimeSeriesResults(data.results);
            resultsDiv.style.display = 'block';
        })
        .catch(error => {
            spinner.classList.add('d-none');
            errorDiv.textContent = 'An error occurred during forecasting. Please try again.';
            errorDiv.style.display = 'block';
            console.error('Error:', error);
        });
    });

    function displayVarAnalysisResults(results) {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        
        // Risk Metrics Overview
        document.getElementById('varRiskMetrics').innerHTML = `
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-label">Portfolio Value</div>
                    <div class="metric-value">$${results.portfolio_value.toLocaleString()}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Data Points</div>
                    <div class="metric-value">${results.data_points} days</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Risk Level</div>
                    <div class="metric-value ${results.risk_assessment.risk_level.toLowerCase() === 'high' ? 'negative-change' : results.risk_assessment.risk_level.toLowerCase() === 'medium' ? 'neutral' : 'positive-change'}">
                        ${results.risk_assessment.risk_level}
                    </div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Volatility</div>
                    <div class="metric-value">${results.risk_metrics.volatility.toFixed(2)}%</div>
                </div>
            </div>
        `;
        
        // VaR Comparison
        const var95Methods = ['Historical', 'Parametric'];
        let varComparisonHTML = '<div class="table-responsive"><table class="table table-hover" style="background: var(--card-bg); border: 1px solid var(--border-color);"><thead style="background: var(--bg-tertiary);"><tr><th style="color: var(--text-primary);">Method</th><th style="color: var(--text-primary);">95% VaR</th><th style="color: var(--text-primary);">99% VaR</th></tr></thead><tbody style="color: var(--text-secondary);">';
        
        var95Methods.forEach(method => {
            const var95 = method === 'Historical' ? results.historical_var.VaR_95 :
                         results.parametric_var.Parametric_VaR_95;
            const var99 = method === 'Historical' ? results.historical_var.VaR_99 :
                         results.parametric_var.Parametric_VaR_99;
            
            if (var95 !== undefined && var99 !== undefined) {
                varComparisonHTML += `
                    <tr style="background: var(--card-bg); border-color: var(--border-color);">
                        <td style="color: var(--text-primary);"><strong>${method}</strong></td>
                        <td class="negative-change">${var95.toFixed(2)}%</td>
                        <td class="negative-change">${var99.toFixed(2)}%</td>
                    </tr>
                `;
            }
        });
        varComparisonHTML += '</tbody></table></div>';
        document.getElementById('varComparison').innerHTML = varComparisonHTML;
        
        // Expected Shortfall
        document.getElementById('expectedShortfall').innerHTML = `
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-label">ES 95% (CVaR)</div>
                    <div class="metric-value negative-change">${results.expected_shortfall.ES_95.toFixed(2)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ES 99% (CVaR)</div>
                    <div class="metric-value negative-change">${results.expected_shortfall.ES_99.toFixed(2)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ES 95% ($)</div>
                    <div class="metric-value negative-change">$${results.expected_shortfall.ES_95_dollars.toFixed(0)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ES 99% ($)</div>
                    <div class="metric-value negative-change">$${results.expected_shortfall.ES_99_dollars.toFixed(0)}</div>
                </div>
            </div>
        `;
        
        // Risk Assessment
        document.getElementById('varRiskAssessment').innerHTML = `
            <div class="alert alert-${results.risk_assessment.risk_level.toLowerCase() === 'high' ? 'danger' : results.risk_assessment.risk_level.toLowerCase() === 'medium' ? 'warning' : 'success'}">
                <strong>Risk Assessment:</strong> ${results.risk_assessment.risk_level} Risk Level<br>
                <strong>Average VaR (95%):</strong> ${results.risk_assessment.average_var_95.toFixed(2)}%<br>
                <strong>Sharpe Ratio:</strong> ${results.risk_metrics.sharpe_ratio.toFixed(3)}<br>
                <strong>Max Drawdown:</strong> ${results.risk_metrics.max_drawdown.toFixed(2)}%
            </div>
        `;
        
        // Recommendations
        document.getElementById('varRecommendations').innerHTML = `
            <div class="alert alert-info">
                ${results.risk_assessment.recommendations.map(rec => `<div>• ${rec}</div>`).join('')}
            </div>
        `;
        
        // Chart - Returns Distribution
        const trace = {
            x: results.returns_data.returns,
            type: 'histogram',
            name: 'Daily Returns',
            nbinsx: 50,
            marker: { color: 'rgba(100, 150, 200, 0.7)' }
        };
        
        const layout = {
            title: `Risk Distribution - ${results.symbol}`,
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: isDark ? '#e0e0e0' : '#1a202c' },
            xaxis: { 
                title: 'Daily Returns (%)',
                gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
            },
            yaxis: { 
                title: 'Frequency',
                gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
            },
            showlegend: false
        };
        
        Plotly.newPlot('varChart', [trace], layout);
    }

    function displayTimeSeriesResults(results) {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        
        // Forecast Summary
        document.getElementById('forecastSummary').innerHTML = `
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-label">Current Price</div>
                    <div class="metric-value">$${results.current_price.toFixed(2)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Forecast Horizon</div>
                    <div class="metric-value">${results.forecast_days} days</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Data Points</div>
                    <div class="metric-value">${results.data_points} days</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Price Method</div>
                    <div class="metric-value">${results.price_forecast ? results.price_forecast.method : 'N/A'}</div>
                </div>
            </div>
        `;
        
        // Model Performance
        let performanceHTML = '<div class="metrics-grid">';
        if (results.accuracy_metrics && !results.accuracy_metrics.error) {
            performanceHTML += `
                <div class="metric-item">
                    <div class="metric-label">MAE</div>
                    <div class="metric-value">$${results.accuracy_metrics.mae.toFixed(2)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">RMSE</div>
                    <div class="metric-value">$${results.accuracy_metrics.rmse.toFixed(2)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">MAPE</div>
                    <div class="metric-value">${results.accuracy_metrics.mape.toFixed(2)}%</div>
                </div>
            `;
        }
        if (results.price_forecast && results.price_forecast.model_info) {
            performanceHTML += `
                <div class="metric-item">
                    <div class="metric-label">ARIMA Order</div>
                    <div class="metric-value">(${results.price_forecast.arima_order ? results.price_forecast.arima_order.join(',') : 'N/A'})</div>
                </div>
            `;
        }
        performanceHTML += '</div>';
        document.getElementById('modelPerformance').innerHTML = performanceHTML;
        
        // Investment Insights
        document.getElementById('forecastInsights').innerHTML = `
            <div class="alert alert-info">
                <h6>Market Insights</h6>
                ${results.analysis.insights.map(insight => `<div>• ${insight}</div>`).join('')}
                <hr>
                <h6>Investment Recommendations</h6>
                ${results.analysis.recommendations.map(rec => `<div>• ${rec}</div>`).join('')}
            </div>
        `;
        
        // Price Forecast Chart
        if (results.price_forecast && results.price_forecast.success) {
            const historicalTrace = {
                x: results.historical_data.dates,
                y: results.historical_data.prices,
                name: 'Historical Prices',
                type: 'scatter',
                line: { color: '#00ff88', width: 2 }
            };
            
            const forecastTrace = {
                x: results.price_forecast.forecast_dates,
                y: results.price_forecast.forecast_prices,
                name: 'Price Forecast',
                type: 'scatter',
                line: { color: '#ff6b6b', width: 2, dash: 'dash' }
            };
            
            const upperBoundTrace = {
                x: results.price_forecast.forecast_dates,
                y: results.price_forecast.confidence_intervals.upper_95,
                name: 'Upper 95% CI',
                type: 'scatter',
                line: { color: 'rgba(255, 107, 107, 0.3)', width: 1 },
                fill: 'tonexty',
                fillcolor: 'rgba(255, 107, 107, 0.1)',
                showlegend: false
            };
            
            const lowerBoundTrace = {
                x: results.price_forecast.forecast_dates,
                y: results.price_forecast.confidence_intervals.lower_95,
                name: 'Lower 95% CI',
                type: 'scatter',
                line: { color: 'rgba(255, 107, 107, 0.3)', width: 1 },
                showlegend: false
            };
            
            const priceLayout = {
                title: `Price Forecast - ${results.symbol}`,
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: isDark ? '#e0e0e0' : '#1a202c' },
                xaxis: { 
                    title: 'Date',
                    gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                },
                yaxis: { 
                    title: 'Price ($)',
                    gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                },
                showlegend: true,
                legend: { x: 0, y: 1 }
            };
            
            Plotly.newPlot('priceForecastChart', [historicalTrace, lowerBoundTrace, upperBoundTrace, forecastTrace], priceLayout);
        }
        
        // Volatility Forecast Chart
        if (results.volatility_forecast && results.volatility_forecast.success) {
            const volTrace = {
                x: results.volatility_forecast.forecast_dates,
                y: results.volatility_forecast.annualized_forecast_vol,
                name: 'Volatility Forecast',
                type: 'scatter',
                line: { color: '#ffc107', width: 2 }
            };
            
            const volLayout = {
                title: `Volatility Forecast - ${results.symbol} (${results.volatility_forecast.method})`,
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: isDark ? '#e0e0e0' : '#1a202c' },
                xaxis: { 
                    title: 'Date',
                    gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                },
                yaxis: { 
                    title: 'Annualized Volatility (%)',
                    gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                },
                showlegend: true,
                legend: { x: 0, y: 1 }
            };
            
            Plotly.newPlot('volatilityForecastChart', [volTrace], volLayout);
        }
    }

    // Paper Trading Functions
    function loadPaperTransactions() {
        const historyDiv = document.getElementById('paperTransactionHistory');
        
        // Show loading state
        historyDiv.innerHTML = `
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading your trading history...</div>
            </div>
        `;
        
        fetch('/paper_transactions')
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    historyDiv.innerHTML = `
                        <div class="no-transactions-state">
                            <div class="no-transactions-icon">📊</div>
                            <div class="no-transactions-title">Ready to Start Trading?</div>
                            <div class="no-transactions-subtitle">No transactions yet. Start practicing by buying some stocks!</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="transaction-list">';
                data.forEach(transaction => {
                    const typeClass = transaction.type === 'BUY' ? 'buy-transaction' : 'sell-transaction';
                    const typeColor = transaction.type === 'BUY' ? 'profit-text' : 'loss-text';
                    const typeIcon = transaction.type === 'BUY' ? '🟢' : '🔴';
                    const typeSign = transaction.type === 'BUY' ? '-' : '+';
                    
                    html += `
                        <div class="transaction-item ${typeClass}">
                            <div class="transaction-header">
                                <div class="transaction-symbol">
                                    ${typeIcon} <strong>${transaction.symbol}</strong>
                                </div>
                                <div class="transaction-amount ${typeColor}">
                                    ${typeSign}$${transaction.total.toFixed(2)}
                                </div>
                            </div>
                            <div class="transaction-details">
                                <span>${transaction.shares} shares @ $${transaction.price.toFixed(2)}</span>
                                <span>${transaction.date}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                historyDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading transactions:', error);
                historyDiv.innerHTML = `
                    <div class="no-transactions-state">
                        <div class="no-transactions-icon">⚠️</div>
                        <div class="no-transactions-title">Loading Error</div>
                        <div class="no-transactions-subtitle">Unable to load transaction history. Please try again.</div>
                    </div>
                `;
            });
    }

    function confirmResetPaperPortfolio() {
        if (confirm('Are you sure you want to reset your paper trading portfolio? This will delete all positions and transactions, and reset your virtual cash to $100,000.')) {
            window.location.href = '/reset_paper_portfolio';
        }
    }

    // Display functions for Risk Analysis results
    function displayFundamentalRiskResults(results) {
        // Altman Z-Score
        document.getElementById('altmanZScore').innerHTML = `
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Z-Score</div>
                    <div class="metric-value">${results.altman_z_score.z_score.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Risk Zone</div>
                    <div class="metric-value ${getZScoreClass(results.altman_z_score.z_score)}">${results.altman_z_score.interpretation}</div>
                </div>
            </div>
            <div class="mt-3">
                <h6>Z-Score Components:</h6>
                <small>
                    <strong>Working Capital/Total Assets:</strong> ${results.altman_z_score.components.wc_ta.toFixed(3)}<br>
                    <strong>Retained Earnings/Total Assets:</strong> ${results.altman_z_score.components.re_ta.toFixed(3)}<br>
                    <strong>EBIT/Total Assets:</strong> ${results.altman_z_score.components.ebit_ta.toFixed(3)}<br>
                    <strong>Market Cap/Total Liabilities:</strong> ${results.altman_z_score.components.mve_tl.toFixed(3)}<br>
                    <strong>Sales/Total Assets:</strong> ${results.altman_z_score.components.s_ta.toFixed(3)}
                </small>
            </div>
        `;

        // Interest Coverage Ratio
        document.getElementById('interestCoverage').innerHTML = `
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Coverage Ratio</div>
                    <div class="metric-value">${results.interest_coverage.ratio.toFixed(2)}x</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Risk Level</div>
                    <div class="metric-value ${getCoverageClass(results.interest_coverage.ratio)}">${results.interest_coverage.interpretation}</div>
                </div>
            </div>
        `;

        // Risk Assessment
        document.getElementById('fundamentalRiskAssessment').innerHTML = `
            <div class="alert alert-info">
                <h6>Risk Assessment Summary:</h6>
                <p><strong>Altman Z-Score:</strong> ${results.altman_z_score.risk_assessment}</p>
                <p><strong>Interest Coverage:</strong> ${results.interest_coverage.risk_assessment}</p>
                <p><strong>Overall Recommendation:</strong> ${results.overall_assessment || 'Monitor both metrics for comprehensive risk evaluation'}</p>
            </div>
        `;
    }

    function displayTechnicalRiskResults(results) {
        // ATR Analysis
        document.getElementById('atrAnalysis').innerHTML = `
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Current Price</div>
                    <div class="metric-value">$${results.current_price.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">14-Day ATR</div>
                    <div class="metric-value">$${results.atr_14_day.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ATR %</div>
                    <div class="metric-value">${results.atr_percentage.toFixed(2)}%</div>
                </div>
            </div>
        `;

        // Support Zone Analysis
        document.getElementById('supportZoneAnalysis').innerHTML = `
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Support Level</div>
                    <div class="metric-value">$${results.support_level.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Downside Risk</div>
                    <div class="metric-value">$${results.downside_risk_dollars.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Risk in ATR Units</div>
                    <div class="metric-value">${results.atr_risk_units.toFixed(2)} ATRs</div>
                </div>
                ${results.risk_days ? `
                <div class="metric-card">
                    <div class="metric-label">Risk Days</div>
                    <div class="metric-value">${results.risk_days.toFixed(1)} days</div>
                </div>
                ` : ''}
            </div>
        `;

        // Risk Assessment
        document.getElementById('technicalRiskAssessment').innerHTML = `
            <div class="alert alert-info">
                <h6>Technical Risk Assessment:</h6>
                <p><strong>Volatility Risk:</strong> ${results.risk_interpretation}</p>
                <p><strong>Support Analysis:</strong> ${results.support_analysis || 'Current price is ' + 
                    (results.downside_risk_dollars > 0 ? 'above support level' : 'at or below support level')}</p>
                ${results.recommendations ? `<p><strong>Recommendations:</strong> ${results.recommendations}</p>` : ''}
            </div>
        `;
    }

    // Helper functions for styling
    function getZScoreClass(zScore) {
        if (zScore < 1.8) return 'text-danger';
        if (zScore <= 3.0) return 'text-warning';
        return 'text-success';
    }

    function getCoverageClass(ratio) {
        if (ratio < 1.5) return 'text-danger';
        if (ratio <= 5.0) return 'text-warning';
        return 'text-success';
    }

    // Load transaction history on page load
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            const historyContainer = document.getElementById('paperTransactionHistory');
            if (historyContainer) {
                loadPaperTransactions();
            }
        }, 500);
    });

    </script>

    <!-- Paper Trading Buy Modal -->
    <div class="modal fade" id="paperBuyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">🟢 Paper Trading - Buy Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('paper_buy') }}" method="POST" id="paperBuyForm">
                        <div class="mb-3">
                            <label class="form-label">Stock Symbol</label>
                            <input type="text" class="form-control" name="symbol" id="buyStockSymbol" 
                                   placeholder="e.g., AAPL" 
                                   pattern="[A-Za-z]{1,5}" 
                                   maxlength="5"
                                   title="Enter 1-5 letters only"
                                   required>
                            <div class="invalid-feedback">
                                Please enter a valid stock symbol (1-5 letters only).
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Number of Shares</label>
                            <input type="number" class="form-control" name="shares" 
                                   placeholder="Enter shares" 
                                   step="0.01" 
                                   min="0.01" 
                                   max="10000"
                                   required>
                            <div class="invalid-feedback">
                                Please enter a positive number of shares.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Purchase Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="price" id="buyPurchasePrice" 
                                       placeholder="Price per share" 
                                       step="0.01" 
                                       min="0.01" 
                                       max="10000"
                                       required>
                                <button type="button" class="btn btn-outline-secondary" id="getCurrentPriceBuy">Get Current</button>
                            </div>
                            <div class="invalid-feedback">
                                Please enter a positive price per share.
                            </div>
                            <small class="form-text text-muted">Default is current market price. You can modify for practice scenarios.</small>
                        </div>
                        <div class="alert alert-info">
                            <strong>💰 Virtual Cash Available:</strong> ${{ "%.2f"|format(paper_summary.cash_balance) }}
                        </div>
                        <div class="alert alert-warning">
                            <strong>📋 Note:</strong> This is paper trading with virtual money. You can use current market price or set custom price for practice.
                        </div>
                        <button type="submit" class="btn btn-success w-100">Execute Buy Order</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Paper Trading Sell Modal -->
    <div class="modal fade" id="paperSellModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">🔴 Paper Trading - Sell Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('paper_sell') }}" method="POST" id="paperSellForm">
                        <div class="mb-3">
                            <label class="form-label">Stock Symbol</label>
                            <select class="form-control" name="symbol" id="sellStockSymbol" required>
                                <option value="">Select a stock to sell</option>
                                {% for item in paper_portfolio %}
                                <option value="{{ item.symbol }}">{{ item.symbol }} ({{ "%.2f"|format(item.shares) }} shares @ ${{ "%.2f"|format(item.average_price) }})</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Please select a stock to sell.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Number of Shares</label>
                            <input type="number" class="form-control" name="shares" 
                                   placeholder="Enter shares to sell" 
                                   step="0.01" 
                                   min="0.01" 
                                   max="10000"
                                   required>
                            <div class="invalid-feedback">
                                Please enter a positive number of shares.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Sell Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="price" id="sellPrice" 
                                       placeholder="Price per share" 
                                       step="0.01" 
                                       min="0.01" 
                                       max="10000"
                                       required>
                                <button type="button" class="btn btn-outline-secondary" id="getCurrentPriceSell">Get Current</button>
                            </div>
                            <div class="invalid-feedback">
                                Please enter a positive sell price.
                            </div>
                            <small class="form-text text-muted">Default is current market price. You can modify for practice scenarios.</small>
                        </div>
                        <div class="alert alert-info">
                            <strong>📊 Current Holdings:</strong>
                            <ul class="mb-0 mt-2">
                                {% for item in paper_portfolio %}
                                <li>{{ item.symbol }}: {{ "%.2f"|format(item.shares) }} shares purchased @ ${{ "%.2f"|format(item.average_price) }} (Current: ${{ "%.2f"|format(item.current_price) }})</li>
                                {% endfor %}
                                {% if not paper_portfolio %}
                                <li class="text-muted">No positions to sell</li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="alert alert-warning">
                            <strong>📋 Note:</strong> This is paper trading with virtual money. You can use current market price or set custom price for practice.
                        </div>
                        <button type="submit" class="btn btn-danger w-100">Execute Sell Order</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Paper Trading Info Modal -->
    <div class="modal fade" id="paperTradingInfoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ℹ️ Paper Trading Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>What is Paper Trading?</h6>
                    <p>Paper trading allows you to practice buying and selling stocks with virtual money. It's a risk-free way to test investment strategies and learn about the market.</p>
                    
                    <h6>Key Features:</h6>
                    <ul>
                        <li><strong>Risk-Free Learning:</strong> Practice with $100,000 virtual money</li>
                        <li><strong>Real Market Data:</strong> Uses real-time stock prices for realistic simulation</li>
                        <li><strong>Strategy Testing:</strong> Test different investment approaches safely</li>
                        <li><strong>Performance Tracking:</strong> Monitor your virtual portfolio performance</li>
                        <li><strong>Purchase Price Tracking:</strong> See exactly what you paid for each stock</li>
                        <li><strong>Transaction History:</strong> Complete record of all virtual trades</li>
                    </ul>
                    
                    <h6>How to Use:</h6>
                    <ol>
                        <li>Click "Buy" to purchase stocks with virtual money</li>
                        <li>Enter stock symbol (e.g., AAPL, GOOGL) and number of shares</li>
                        <li>Track your purchase price and current performance</li>
                        <li>Click "Sell" to sell stocks from your virtual portfolio</li>
                        <li>Monitor your profit/loss and learn from your decisions</li>
                        <li>Reset your portfolio anytime to start fresh</li>
                    </ol>
                    
                    <div class="alert alert-success">
                        <strong>💡 Pro Tip:</strong> Use this alongside the other analytical tools in your dashboard to make informed virtual trading decisions!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get current price functionality for paper trading modals
        async function getCurrentPrice(symbol) {
            if (!symbol) {
                alert('Please enter a stock symbol first');
                return;
            }
            
            try {
                const response = await fetch(`/get_stock_price/${symbol.toUpperCase()}`);
                const data = await response.json();
                
                if (data.success) {
                    return data.price;
                } else {
                    alert('Unable to fetch current price. Please enter manually.');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching price:', error);
                alert('Error fetching price. Please enter manually.');
                return null;
            }
        }
        
        // Handle Get Current Price button for Buy modal
        document.getElementById('getCurrentPriceBuy').addEventListener('click', async function() {
            const symbolInput = document.getElementById('buyStockSymbol');
            const priceInput = document.getElementById('buyPurchasePrice');
            const symbol = symbolInput.value.trim();
            
            if (!symbol) {
                alert('Please enter a stock symbol first');
                symbolInput.focus();
                return;
            }
            
            // Show loading state
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            this.disabled = true;
            
            const price = await getCurrentPrice(symbol);
            if (price) {
                priceInput.value = price.toFixed(2);
            }
            
            // Reset button state
            this.innerHTML = 'Get Current';
            this.disabled = false;
        });
        
        // Handle Get Current Price button for Sell modal
        document.getElementById('getCurrentPriceSell').addEventListener('click', async function() {
            const symbolSelect = document.getElementById('sellStockSymbol');
            const priceInput = document.getElementById('sellPrice');
            const symbol = symbolSelect.value;
            
            if (!symbol) {
                alert('Please select a stock to sell first');
                symbolSelect.focus();
                return;
            }
            
            // Show loading state
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            this.disabled = true;
            
            const price = await getCurrentPrice(symbol);
            if (price) {
                priceInput.value = price.toFixed(2);
            }
            
            // Reset button state
            this.innerHTML = 'Get Current';
            this.disabled = false;
        });
        
        // Auto-populate price when modal opens if symbol is already entered
        document.getElementById('paperBuyModal').addEventListener('shown.bs.modal', function() {
            const symbolInput = document.getElementById('buyStockSymbol');
            const priceInput = document.getElementById('buyPurchasePrice');
            
            // If symbol is entered but price is not, try to get current price
            if (symbolInput.value.trim() && !priceInput.value) {
                document.getElementById('getCurrentPriceBuy').click();
            }
        });
        
        document.getElementById('paperSellModal').addEventListener('shown.bs.modal', function() {
            const symbolSelect = document.getElementById('sellStockSymbol');
            const priceInput = document.getElementById('sellPrice');
            
            // If symbol is selected but price is not, try to get current price
            if (symbolSelect.value && !priceInput.value) {
                document.getElementById('getCurrentPriceSell').click();
            }
        });

        // Auto-hide flash messages after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.flash-message');
            
            flashMessages.forEach(function(message) {
                // Auto-hide after 5 seconds
                setTimeout(function() {
                    if (message && message.parentNode) {
                        const alert = new bootstrap.Alert(message);
                        alert.close();
                    }
                }, 5000);
            });
        });

        // Enhanced validation for paper trading forms
        function validateTickerSymbol(input) {
            const symbol = input.value.trim().toUpperCase();
            
            // Basic validation: only letters, 1-5 characters
            const isValid = /^[A-Z]{1,5}$/.test(symbol);
            
            if (!isValid && symbol.length > 0) {
                input.style.borderColor = '#dc3545';
                input.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
                input.classList.add('is-invalid');
            } else {
                input.style.borderColor = '';
                input.style.boxShadow = '';
                input.classList.remove('is-invalid');
                if (symbol.length > 0) {
                    input.classList.add('is-valid');
                }
            }
            
            return isValid;
        }

        // Add real-time validation to ticker inputs and form submission
        document.addEventListener('DOMContentLoaded', function() {
            const tickerInputs = document.querySelectorAll('#buyStockSymbol');
            
            tickerInputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    validateTickerSymbol(this);
                });
                
                input.addEventListener('blur', function() {
                    if (this.value.trim()) {
                        this.value = this.value.trim().toUpperCase();
                        validateTickerSymbol(this);
                    }
                });
            });

            // Form validation for buy form
            const buyForm = document.getElementById('paperBuyForm');
            if (buyForm) {
                buyForm.addEventListener('submit', function(e) {
                    const symbolInput = document.getElementById('buyStockSymbol');
                    const sharesInput = buyForm.querySelector('input[name="shares"]');
                    const priceInput = buyForm.querySelector('input[name="price"]');
                    
                    let isValid = true;
                    
                    // Validate symbol
                    if (!validateTickerSymbol(symbolInput)) {
                        e.preventDefault();
                        isValid = false;
                        symbolInput.focus();
                    }
                    
                    // Validate shares
                    if (parseFloat(sharesInput.value) <= 0) {
                        e.preventDefault();
                        isValid = false;
                        sharesInput.classList.add('is-invalid');
                        if (isValid) sharesInput.focus();
                    } else {
                        sharesInput.classList.remove('is-invalid');
                    }
                    
                    // Validate price
                    if (parseFloat(priceInput.value) <= 0) {
                        e.preventDefault();
                        isValid = false;
                        priceInput.classList.add('is-invalid');
                        if (isValid) priceInput.focus();
                    } else {
                        priceInput.classList.remove('is-invalid');
                    }
                    
                    if (!isValid) {
                        // Show a user-friendly error message
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger mt-3';
                        alertDiv.innerHTML = '<strong>⚠️ Validation Error:</strong> Please correct the highlighted fields and try again.';
                        
                        // Remove any existing error messages
                        const existingError = buyForm.querySelector('.alert-danger');
                        if (existingError) {
                            existingError.remove();
                        }
                        
                        buyForm.appendChild(alertDiv);
                        
                        // Auto-remove after 5 seconds
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 5000);
                    }
                });
            }

            // Form validation for sell form
            const sellForm = document.getElementById('paperSellForm');
            if (sellForm) {
                sellForm.addEventListener('submit', function(e) {
                    const symbolSelect = document.getElementById('sellStockSymbol');
                    const sharesInput = sellForm.querySelector('input[name="shares"]');
                    const priceInput = sellForm.querySelector('input[name="price"]');
                    
                    let isValid = true;
                    
                    // Validate symbol selection
                    if (!symbolSelect.value) {
                        e.preventDefault();
                        isValid = false;
                        symbolSelect.classList.add('is-invalid');
                        symbolSelect.focus();
                    } else {
                        symbolSelect.classList.remove('is-invalid');
                    }
                    
                    // Validate shares
                    if (parseFloat(sharesInput.value) <= 0) {
                        e.preventDefault();
                        isValid = false;
                        sharesInput.classList.add('is-invalid');
                        if (isValid) sharesInput.focus();
                    } else {
                        sharesInput.classList.remove('is-invalid');
                    }
                    
                    // Validate price
                    if (parseFloat(priceInput.value) <= 0) {
                        e.preventDefault();
                        isValid = false;
                        priceInput.classList.add('is-invalid');
                        if (isValid) priceInput.focus();
                    } else {
                        priceInput.classList.remove('is-invalid');
                    }
                    
                    if (!isValid) {
                        // Show a user-friendly error message
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger mt-3';
                        alertDiv.innerHTML = '<strong>⚠️ Validation Error:</strong> Please correct the highlighted fields and try again.';
                        
                        // Remove any existing error messages
                        const existingError = sellForm.querySelector('.alert-danger');
                        if (existingError) {
                            existingError.remove();
                        }
                        
                        sellForm.appendChild(alertDiv);
                        
                        // Auto-remove after 5 seconds
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 5000);
                    }
                });
            }
        });
    </script>

</body>
</html>